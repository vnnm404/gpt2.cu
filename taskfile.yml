# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: "3"

vars:
  UID: { sh: "id -u" }
  GID: { sh: "id -g" }
env:
  DATA_ROOT: "{{.ROOT_DIR}}"
  CUDA_ARCH:
    sh: |
      which nvidia-smi 2>&1>/dev/null || exit 0
      nvidia-smi --query-gpu=compute_cap --format=csv,noheader | sed "s/\.//"

tasks:
  build:
    cmds:
      - cmake -B build
      - cmake --build build -j8
    sources:
      - ./**/CMakeLists.txt
      - ./**/*.{cu,cuh,c,cpp,h,hpp}

  clean:
    cmds:
      - rm -rf build

  infer:
    deps: [build]
    dir: build
    cmds:
      - ./programs/inference

  train:
    deps: [build]
    dir: build
    cmds:
      - ./programs/train

  test:train:
    deps: [build]
    dir: build
    cmds:
      - ./tests/test_train

  test:train_mk:
    deps: [build]
    dir: build
    cmds:
      - ./tests/test_train_mk

  # Programs
  profile:inference:
    deps: [build]
    cmds:
      - uv run benchmark/run_nsys.py --app ./build/programs/inference {{.CLI_ARGS}}

  profile:train:
    deps: [build]
    cmds:
      - uv run benchmark/run_nsys.py --app ./build/programs/train {{.CLI_ARGS}}

  # Tests
  profile:test_train:
    deps: [build]
    cmds:
      - uv run benchmark/run_nsys.py --app ./build/tests/test_train {{.CLI_ARGS}}

  profile:test_train_mk:
    deps: [build]
    cmds:
      - uv run benchmark/run_nsys.py --app ./build/tests/test_train_mk {{.CLI_ARGS}}

  bmpy:
    deps: [build]
    cmds:
      - uv run python benchmark/mk_bench.py --lib build/tests/libmk_entrypoint.so

  hermetic:infer:
    cmds:
      - docker build -t gpt2cu:pure --target=pure .
      - docker run --rm --gpus all gpt2cu:pure

  dbuild:
    cmds:
      - docker build -t gpt2cu:dev --target=dev .

  drun:
    cmds:
      - |
        docker run --rm -it --gpus all \
          -e USER_UID={{.UID}} \
          -e USER_GID={{.GID}} \
          -e TERM \
          -e DATA_ROOT=/workspace/data \
          -w /workspace \
          --mount=type=volume,src=gpt2cu-nix,dst=/nix \
          --mount=type=bind,src=$PWD,dst=/workspace \
          gpt2cu:dev

